#!/bin/bash
set -e

#env
cd $(dirname $0)
ES_VERSION=1.4.0

#utilities
source utils.sh

#build our image
step Generating Dockerfile
cat << EOF > Dockerfile
#this dockerfile is auto-generated by the "bootstrap" script
FROM dockerfile/java:oracle-java7
$(test -z $http_proxy || echo "ENV http_proxy $http_proxy")
$(test -z $https_proxy || echo "ENV https_proxy $https_proxy")
RUN \
 cd /tmp && \
   wget https://download.elasticsearch.org/elasticsearch/elasticsearch/elasticsearch-$ES_VERSION.tar.gz && \
   tar xvzf elasticsearch-$ES_VERSION.tar.gz && \
   rm -f elasticsearch-$ES_VERSION.tar.gz && \
   mv /tmp/elasticsearch-$ES_VERSION /elasticsearch
WORKDIR /elasticsearch
RUN bin/plugin -install mobz/elasticsearch-head
RUN bin/plugin -install karmi/elasticsearch-paramedic
RUN bin/plugin -install lmenezes/elasticsearch-kopf
RUN bin/plugin -install lukas-vlcek/bigdesk
RUN bin/plugin -install xyu/elasticsearch-whatson/0.1.3
RUN bin/plugin -install royrusso/elasticsearch-HQ
RUN bin/plugin -install polyfractal/elasticsearch-segmentspy
RUN bin/plugin -install andrewvc/elastic-hammer
RUN bin/plugin -install polyfractal/elasticsearch-inquisitor
ADD config /elasticsearch/config
WORKDIR /data
CMD ["/elasticsearch/bin/elasticsearch"]
EXPOSE 9200
EXPOSE 9300
EOF

step Building docker image
docker build --tag="$(whoami)/elasticsearch-full" .

#spawn function
spawn_es_node() {
  node_name=$1
  node_type=$2
  port_9200=$3
  port_9300=$4
  docker run -d \
    --name $node_name \
    --publish $port_9200:9200 \
    --publish $port_9300:9300 \
    $(whoami)/elasticsearch-full \
    /elasticsearch/bin/elasticsearch -Xms64m -Xmx64m -Des.config=/elasticsearch/config/elasticsearch-$node_type.yml
}

step Starting router node
spawn_es_node router routing 9200 9300

step Starting data1 node
spawn_es_node data1  data    9201 9301

step Starting data2 node
spawn_es_node data2  data    9202 9302

step Starting data3 node
spawn_es_node data3  data    9203 9303

#wait!
step Waiting 15s for cluster to wake up
sleep 15

#browser part
step Opening URLs
esaddress=$(echo $DOCKER_HOST|perl -pe 's#^$#localhost#,s#tcp://(.*?):.*#$1#')
set +e
open_url http://$esaddress:9200/_plugin/head/
open_url http://$esaddress:9200/_plugin/paramedic/
open_url http://$esaddress:9200/_plugin/kopf/
open_url http://$esaddress:9200/_plugin/bigdesk/
open_url http://$esaddress:9200/_plugin/whatson/
open_url http://$esaddress:9200/_plugin/HQ/
open_url http://$esaddress:9200/_plugin/segmentspy/
open_url http://$esaddress:9200/_plugin/elastic-hammer/
open_url http://$esaddress:9200/_plugin/inquisitor/
set -e
